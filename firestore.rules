rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Users can only access their own user document
    match /users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Workspaces - users can only access workspaces they own or are members of
    match /workspaces/{workspaceId} {
      allow read, write: if isAuthenticated() && 
        (resource == null || 
         resource.data.createdBy == request.auth.uid ||
         request.auth.uid in resource.data.members);
    }
    
    // Projects - simplified rules
    match /projects/{projectId} {
      allow read, write: if isAuthenticated() && 
        (resource == null || 
         resource.data.createdBy == request.auth.uid);
    }
    
    // API Keys - users can only access their own API keys
    match /apiKeys/{apiKeyId} {
      allow read, write: if isAuthenticated() && 
        (resource == null || 
         resource.data.userId == request.auth.uid ||
         resource.data.createdBy == request.auth.uid ||
         resource.data.uid == request.auth.uid);
    }
    
    // Team Members - simplified rules
    match /teamMembers/{memberId} {
      allow read, write: if isAuthenticated() && 
        (resource == null || 
         resource.data.ownerId == request.auth.uid);
    }
    
    // Sources - simplified rules
    match /sources/{sourceId} {
      allow read, write: if isAuthenticated() && 
        (resource == null || 
         resource.data.ownerId == request.auth.uid);
    }
    
    // Chat Messages - simplified rules
    match /chatMessages/{messageId} {
      allow read, write: if isAuthenticated() && 
        (resource == null || 
         resource.data.userId == request.auth.uid);
    }
    
    // Progress Goals - users can only access their own goals
    match /progressGoals/{goalId} {
      allow read, write: if isAuthenticated() && 
        (resource == null || resource.data.userId == request.auth.uid);
    }
    
    // Activity Logs - simplified rules
    match /activities/{activityId} {
      allow read, write: if isAuthenticated() && 
        (resource == null || 
         resource.data.userId == request.auth.uid);
    }
    
    // Fallback rule for any other collections
    match /{document=**} {
      allow read, write: if isAuthenticated();
    }
  }
}

